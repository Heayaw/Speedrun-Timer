<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Speedrun Video Timer</title>
<link rel="icon" href="data:,">
<script src="https://cdn.jsdelivr.net/npm/mediainfo.js/dist/mediainfo.min.js"></script>

<style>
body{
    font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
    margin:40px;
    text-align:center;
    background:#0e0e0e;
    color:#f0f0f0
}

h1{margin-bottom:20px}

input,select{
    background:#1e1e1e;
    color:#fff;
    border:1px solid #555;
    padding:10px;
    border-radius:8px;
    width:280px;
    margin-bottom:10px
}

button{
    padding:8px 12px;
    font-size:13px;
    background:linear-gradient(120deg,#444,#222,#444);
    color:#fff;
    border:none;
    border-radius:6px;
    cursor:pointer
}

button:hover{transform:scale(1.05)}

.controls-container{
    display:flex;
    justify-content:center;
    gap:16px;
    margin-top:20px;
    flex-wrap:nowrap
}

.control-box{
    display:flex;
    gap:6px;
    padding:10px;
    background:#1c1c1c;
    border-radius:10px
}

.control-box button{
    min-width:52px;
    height:32px
}

.mod-controls{
    display:flex;
    flex-direction:column;
    gap:8px;
    padding:12px;
    background:#1c1c1c;
    border-radius:10px;
    min-width:180px
}

#modNote{
    margin-top:25px;
    font-weight:bold;
    color:#ff5050;
    background:#1a1a1a;
    padding:10px;
    border-radius:8px;
    max-width:900px;
    margin-left:auto;
    margin-right:auto;
    white-space:pre-wrap
}

.pause-list{margin-top:20px;color:#ffde59}

.pause-item{
    margin:8px auto;
    padding:10px;
    background:#2c2c2c;
    border-radius:8px;
    max-width:500px;
    display:flex;
    justify-content:space-between;
    align-items:center
}

.pause-item button{
    background:#880000;
    padding:5px 10px;
    font-size:12px
}
</style>
</head>

<body>

<h1>Speedrun Video Timer</h1>

<select id="videoSource" onchange="switchSource()">
    <option value="youtube">YouTube</option>
    <option value="gdrive">Google Drive</option>
    <option value="file">Local File</option>
</select><br><br>

<div id="youtubeSection">
    <input id="videoUrl" placeholder="Enter YouTube URL">
    <button onclick="loadVideo()">Load</button>
</div>

<div id="gdriveSection" style="display:none">
    <input id="gdriveUrl" placeholder="Enter Google Drive link">
    <button onclick="loadGDrive()">Load</button>
</div>

<div id="fileSection" style="display:none">
    <input type="file" id="videoFile" accept="video/*">
</div>

<br>

<input type="number" id="fpsInput" value="60" min="1" max="240" style="width:120px">
<button onclick="resetRun()">Reset Run</button>

<br><br>
<div id="youtubePlayer"></div>

<div class="controls-container">

    <!-- FRAMES -->
    <div class="control-box">
        <button onclick="skipFrames(-10)">-10F</button>
        <button onclick="skipFrames(-5)">-5F</button>
        <button onclick="skipFrames(-1)">-1F</button>
        <button onclick="skipFrames(1)">+1F</button>
        <button onclick="skipFrames(5)">+5F</button>
        <button onclick="skipFrames(10)">+10F</button>
    </div>

    <!-- SECONDS -->
    <div class="control-box">
        <button onclick="skipSeconds(-10)">-10S</button>
        <button onclick="skipSeconds(-5)">-5S</button>
        <button onclick="skipSeconds(-1)">-1S</button>
        <button onclick="skipSeconds(1)">+1S</button>
        <button onclick="skipSeconds(5)">+5S</button>
        <button onclick="skipSeconds(10)">+10S</button>
    </div>

    <!-- MINUTES (RESTORED) -->
    <div class="control-box">
        <button onclick="skipSeconds(-600)">-10M</button>
        <button onclick="skipSeconds(-300)">-5M</button>
        <button onclick="skipSeconds(-60)">-1M</button>
        <button onclick="skipSeconds(60)">+1M</button>
        <button onclick="skipSeconds(300)">+5M</button>
        <button onclick="skipSeconds(600)">+10M</button>
    </div>

    <!-- MOD CONTROLS -->
    <div class="mod-controls">
        <button onclick="addPause()">Add Pause</button>
        <div id="pauseSection" style="display:none">
            <button onclick="setPauseStart()">Set Pause Start</button>
            <button onclick="setPauseEnd()">Set Pause End</button>
        </div>
        <button onclick="setStartTime()">Set Start Time</button>
        <button onclick="setEndTime()">Set End Time</button>
        <button onclick="displayCurrentFrame()">Show Current Frame</button>
        <button onclick="exportRunData()">Export Run Data</button>
    </div>

</div>

<div id="modNote"></div>
<button onclick="copyModMessage()">Copy Mod Message</button>
<div id="pauseList" class="pause-list"></div>

<script>
let player,startTime=0,endTime=0,pauses=[],currentPause=null

function switchSource(){
    ["youtube","gdrive","file"].forEach(s=>{
        document.getElementById(s+"Section").style.display="none"
    })
    document.getElementById(videoSource.value+"Section").style.display="block"
}

function loadYouTubeAPI(){
    const s=document.createElement("script")
    s.src="https://www.youtube.com/iframe_api"
    document.body.appendChild(s)
}
loadYouTubeAPI()

function clearPlayer(){
    const c=youtubePlayer
    if(player?.destroy)player.destroy()
    c.innerHTML=""
    player=null
}

function loadVideo(){
    resetRun()
    clearPlayer()
    let id
    try{
        const u=new URL(videoUrl.value)
        id=u.searchParams.get("v")||u.pathname.slice(1)
    }catch{return alert("Invalid URL")}
    player=new YT.Player("youtubePlayer",{videoId:id})
}

function loadGDrive(){
    resetRun()
    clearPlayer()
    const u=new URL(gdriveUrl.value)
    const id=u.searchParams.get("id")||u.pathname.split("/file/d/")[1]?.split("/")[0]
    if(!id)return alert("Invalid Drive link")
    const v=document.createElement("video")
    v.controls=true
    v.width=640
    v.src=`https://drive.google.com/uc?export=download&id=${id}`
    youtubePlayer.appendChild(v)
    player=v
}

videoFile.onchange=e=>{
    resetRun()
    clearPlayer()
    const v=document.createElement("video")
    v.controls=true
    v.width=640
    v.src=URL.createObjectURL(e.target.files[0])
    youtubePlayer.appendChild(v)
    player=v
}

const fps=()=>+fpsInput.value||60
const time=()=>player?.getCurrentTime?.()||player?.currentTime||0
const seek=t=>player?.seekTo?player.seekTo(t,true):player.currentTime=t

const skipFrames=f=>seek((Math.round(time()*fps())+f)/fps())
const skipSeconds=s=>seek(time()+s)

function addPause(){currentPause={};pauseSection.style.display="block"}
function setPauseStart(){currentPause.start=time()}
function setPauseEnd(){
    currentPause.end=time()
    pauses.push(currentPause)
    currentPause=null
    pauseSection.style.display="none"
    renderPauses()
    updateModNote()
}

function fmt(sec){
    const ms=Math.round(sec*1000)
    return `${Math.floor(ms/60000)}:${String(Math.floor(ms/1000)%60).padStart(2,"0")}.${String(ms%1000).padStart(3,"0")}`
}

function updateModNote(){
    if(!startTime||!endTime){modNote.innerText="Set both start and end times.";return}
    let total=endTime-startTime
    pauses.forEach(p=>total-=p.end-p.start)
    let t=`Start: ${fmt(startTime)}`
    pauses.forEach((p,i)=>t+=` | Pause ${i+1}: ${fmt(p.start)} → ${fmt(p.end)}`)
    t+=` | End: ${fmt(endTime)}`
    modNote.innerText=`${t}\nFinal Time: ${fmt(total)} (${Math.round(total*fps())} frames @ ${fps()} FPS)`
}

function renderPauses(){
    pauseList.innerHTML=""
    pauses.forEach((p,i)=>{
        pauseList.innerHTML+=`<div class="pause-item">
        Pause ${i+1}: ${fmt(p.start)} → ${fmt(p.end)}
        <button onclick="pauses.splice(${i},1);renderPauses();updateModNote()">Remove</button>
        </div>`
    })
}

const setStartTime=()=>{startTime=time();updateModNote()}
const setEndTime=()=>{endTime=time();updateModNote()}
const displayCurrentFrame=()=>alert(Math.round(time()*fps()))
const exportRunData=()=>{
    const a=document.createElement("a")
    a.href=URL.createObjectURL(new Blob([JSON.stringify({startTime,endTime,pauses,fps:fps()},null,2)]))
    a.download="run_data.json"
    a.click()
}
const copyModMessage=()=>navigator.clipboard.writeText(modNote.innerText)
const resetRun=()=>{startTime=endTime=0;pauses=[];pauseList.innerHTML="";modNote.innerText=""}
</script>

</body>
</html>
