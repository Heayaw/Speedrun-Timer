<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Speedrun Video Timer</title>
    <link rel="icon" href="data:,">
    <script src="https://cdn.jsdelivr.net/npm/mediainfo.js/dist/mediainfo.min.js"></script>
    <style>
        body {font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;margin:40px;text-align:center;background-color:#0e0e0e;color:#f0f0f0}
        h1{font-size:2em;margin-bottom:20px;color:#fff}
        input[type="text"],input[type="number"],input[type="file"],select{background-color:#1e1e1e;color:#fff;border:1px solid #555;padding:10px;border-radius:8px;width:280px;margin-bottom:10px}
        input:focus,select:focus{outline:none;border-color:#ff5050}
        button{margin:5px;padding:10px;font-size:14px;background:linear-gradient(120deg,#444,#222,#444);color:white;border:none;border-radius:6px;cursor:pointer;width:150px}
        button:hover{transform:scale(1.05)}
        .controls-container{display:flex;justify-content:center;flex-wrap:wrap;gap:20px;margin-top:20px}
        .control-box,.mod-controls{display:flex;flex-direction:column;align-items:center;padding:15px;background:#1c1c1c;border-radius:12px;min-width:180px}
        #modNote{margin-top:25px;font-weight:bold;color:#ff5050;background-color:#1a1a1a;padding:10px;border-radius:8px;max-width:800px;margin:auto}
        .pause-list{margin-top:20px;color:#ffde59}
        .pause-item{margin:8px auto;padding:10px;background-color:#2c2c2c;border-radius:8px;max-width:500px;display:flex;justify-content:space-between;align-items:center}
        .pause-item button{background-color:#880000;width:auto;padding:5px 10px;font-size:12px}
        #pauseSection{margin-top:10px}
    </style>
</head>

<body>
<h1>Speedrun Video Timer</h1>

<h2>Select Video Source</h2>
<select id="videoSource" onchange="switchSource()">
    <option value="youtube">YouTube</option>
    <option value="gdrive">Google Drive</option>
    <option value="file">Local File</option>
</select><br><br>

<div id="youtubeSection">
    <input type="text" id="videoUrl" placeholder="Enter YouTube URL">
    <button onclick="loadVideo()">Load YouTube Video</button>
</div>

<div id="gdriveSection" style="display:none;">
    <input type="text" id="gdriveUrl" placeholder="Enter Google Drive link">
    <button onclick="loadGDrive()">Load Google Drive Video</button>
</div>

<div id="fileSection" style="display:none;">
    <input type="file" id="videoFile" accept="video/*">
</div><br>

<input type="number" id="fpsInput" value="60" min="1" max="240" style="width:120px;">
<button onclick="resetRun()">Reset Run</button><br><br>

<div id="youtubePlayer"></div><br>

<div class="controls-container">
    <div class="control-box">
        <button onclick="skipFrames(-10)">-10F</button>
        <button onclick="skipFrames(-5)">-5F</button>
        <button onclick="skipFrames(-1)">-1F</button>
        <button onclick="skipFrames(1)">+1F</button>
        <button onclick="skipFrames(5)">+5F</button>
        <button onclick="skipFrames(10)">+10F</button>
    </div>

    <div class="control-box">
        <button onclick="skipSeconds(-10)">-10S</button>
        <button onclick="skipSeconds(-5)">-5S</button>
        <button onclick="skipSeconds(-1)">-1S</button>
        <button onclick="skipSeconds(1)">+1S</button>
        <button onclick="skipSeconds(5)">+5S</button>
        <button onclick="skipSeconds(10)">+10S</button>
    </div>

    <div class="mod-controls">
        <button onclick="addPause()">Add Pause</button>
        <div id="pauseSection" style="display:none;">
            <button onclick="setPauseStart()">Set Pause Start</button>
            <button onclick="setPauseEnd()">Set Pause End</button>
        </div><br>
        <button onclick="setStartTime()">Set Start Time</button>
        <button onclick="setEndTime()">Set End Time</button>
        <button onclick="displayCurrentFrame()">Show Current Frame</button>
        <button onclick="exportRunData()">Export Run Data</button>
    </div>
</div>

<div id="modNote"></div>
<button onclick="copyModMessage()">Copy Mod Message</button>
<div class="pause-list" id="pauseList"></div>

<script>
let player,startTime=0,endTime=0,pauses=[],currentPause=null

function switchSource(){
    ["youtube","gdrive","file"].forEach(s=>{
        document.getElementById(s+"Section").style.display="none"
    })
    document.getElementById(
        document.getElementById("videoSource").value+"Section"
    ).style.display="block"
}

function loadYouTubeAPI(){
    const s=document.createElement("script")
    s.src="https://www.youtube.com/iframe_api"
    document.body.appendChild(s)
}
loadYouTubeAPI()

function clearPlayer(){
    const c=document.getElementById("youtubePlayer")
    if(player&&player.destroy)player.destroy()
    c.innerHTML=""
    player=null
}

function loadVideo(){
    resetRun()
    clearPlayer()
    let id=null
    try{
        const u=new URL(document.getElementById("videoUrl").value.trim())
        if(u.hostname.includes("youtu.be"))id=u.pathname.slice(1)
        else if(u.searchParams.has("v"))id=u.searchParams.get("v")
    }catch{return alert("Invalid YouTube URL")}
    if(!id)return alert("Invalid YouTube URL")
    player=new YT.Player("youtubePlayer",{videoId:id,playerVars:{autoplay:1}})
}

async function loadGDrive(){
    resetRun()
    clearPlayer()
    const url=document.getElementById("gdriveUrl").value.trim()
    let id=null
    try{
        const u=new URL(url)
        if(u.pathname.includes("/file/d/"))
            id=u.pathname.split("/file/d/")[1].split("/")[0]
        else if(u.searchParams.has("id"))
            id=u.searchParams.get("id")
    }catch{}
    if(!id)return alert("Invalid Google Drive link")
    const src=`https://drive.google.com/uc?export=download&id=${id}`
    const v=document.createElement("video")
    v.controls=true
    v.width=600
    v.src=src
    document.getElementById("youtubePlayer").appendChild(v)
    player=v
}

document.getElementById("videoFile").addEventListener("change",e=>{
    if(!e.target.files.length)return
    resetRun()
    clearPlayer()
    const v=document.createElement("video")
    v.controls=true
    v.width=600
    v.src=URL.createObjectURL(e.target.files[0])
    document.getElementById("youtubePlayer").appendChild(v)
    player=v
})

function getFPS(){return parseFloat(fpsInput.value)||60}
function getTime(){return player?.currentTime||player?.getCurrentTime?.()||0}
function seek(t){player?.seekTo?player.seekTo(t,true):player.currentTime=t}

function skipFrames(f){seek((Math.round(getTime()*getFPS())+f)/getFPS())}
function skipSeconds(s){seek(getTime()+s)}

function addPause(){currentPause={};pauseSection.style.display="block"}
function setPauseStart(){currentPause.start=getTime()}
function setPauseEnd(){
    currentPause.end=getTime()
    pauses.push(currentPause)
    currentPause=null
    pauseSection.style.display="none"
    renderPauses()
    updateModNote()
}

function renderPauses(){
    pauseList.innerHTML=""
    pauses.forEach((p,i)=>{
        pauseList.innerHTML+=
        `<div class="pause-item">Pause ${i+1}: ${fmt(p.start)} → ${fmt(p.end)}
        <button onclick="removePause(${i})">Remove</button></div>`
    })
}

function removePause(i){pauses.splice(i,1);renderPauses();updateModNote()}
function setStartTime(){startTime=getTime();updateModNote()}
function setEndTime(){endTime=getTime();updateModNote()}
function displayCurrentFrame(){alert(Math.round(getTime()*getFPS()))}

function fmt(sec){
    const f=Math.round(sec*getFPS())
    const ms=Math.round(f*(1000/getFPS()))
    return `${Math.floor(ms/60000)}:${String(Math.floor(ms/1000)%60).padStart(2,"0")}.${String(ms%1000).padStart(3,"0")}`
}

function updateModNote(){
    if(startTime === 0 || endTime === 0){
        document.getElementById("modNote").innerText =
            "Set both start and end times.";
        return;
    }

    const fps = getFPS();
    let total = endTime - startTime;

    pauses.forEach(p=>{
        if(p.start != null && p.end != null){
            total -= (p.end - p.start);
        }
    });

    let timeline = `Start: ${fmt(startTime)}`;

    pauses.forEach((p,i)=>{
        timeline += ` | Pause ${i+1}: ${fmt(p.start)} → ${fmt(p.end)}`;
    });

    timeline += ` | End: ${fmt(endTime)}`;

    document.getElementById("modNote").innerText =
        `${timeline}\nFinal Time: ${fmt(total)} (${Math.round(total * fps)} frames at ${fps} FPS)`;
}


function exportRunData(){
    const b=new Blob([JSON.stringify({startTime,endTime,pauses,fps:getFPS()},null,2)])
    const a=document.createElement("a")
    a.href=URL.createObjectURL(b)
    a.download="run_data.json"
    a.click()
}

function copyModMessage(){navigator.clipboard.writeText(modNote.innerText)}
function resetRun(){startTime=endTime=0;pauses=[];pauseList.innerHTML="";modNote.innerText=""}
</script>
</body>
</html>
